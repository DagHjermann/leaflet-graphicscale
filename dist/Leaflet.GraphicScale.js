L.Control.GraphicScale=L.Control.extend({options:{position:"bottomleft",updateWhenIdle:false,minUnitWidth:30,maxUnitsWidth:240,fill:"hollow",doubleLine:false},onAdd:function(map){this._map=map;this._possibleUnitsNum=[3,5,2,4];this._possibleUnitsNumLen=this._possibleUnitsNum.length;this._possibleDivisions=[1,.5,.25,.2];this._possibleDivisionsLen=this._possibleDivisions.length;this._scale=this._addScale(this.options);map.on(this.options.updateWhenIdle?"moveend":"move",this._update,this);map.whenReady(this._update,this);return this._scale},onRemove:function(map){map.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScale:function(options){var classNames=["leaflet-control-graphicscale"];if(options.fill){classNames.push("fill");classNames.push("fill-"+options.fill)}if(options.doubleLine){classNames.push("double")}var scale=L.DomUtil.create("div",classNames.join(" "));scale.appendChild(this._buildScaleDom());return scale},_buildScaleDom:function(){var root=document.createElement("div");var units=document.createElement("div");units.className="units";root.appendChild(units);this._units=[];this._unitsLbls=[];for(var i=0;i<5;i++){var unit=L.DomUtil.create("div","unit");units.appendChild(unit);this._units.push(unit);var unitLbl=L.DomUtil.create("div","lbl");unit.appendChild(unitLbl);this._unitsLbls.push(unitLbl);var l1=L.DomUtil.create("div","l1");unit.appendChild(l1);var l2=L.DomUtil.create("div","l2");unit.appendChild(l2);l1.appendChild(L.DomUtil.create("div","l1inner"));l2.appendChild(L.DomUtil.create("div","l2inner"))}return root},_update:function(){var bounds=this._map.getBounds(),centerLat=bounds.getCenter().lat,halfWorldMeters=6378137*Math.PI*Math.cos(centerLat*Math.PI/180),dist=halfWorldMeters*(bounds.getNorthEast().lng-bounds.getSouthWest().lng)/180,size=this._map.getSize(),options=this.options,maxMeters=0;if(size.x>0){var scaleWidthRatio=options.maxWidth/size.x;maxMeters=dist*scaleWidthRatio;this._updateScale(dist,options)}},_updateScale:function(dist,options){var maxMeters=dist;var scale=this._getBestScale(maxMeters,options.minUnitWidth,options.maxUnitsWidth);this._render(scale.unit.unitPx,scale.numUnits,scale.unit.unitMeters)},_getBestScale:function(maxMeters,minUnitWidthPx,maxUnitsWidthPx){var possibleUnits=this._getPossibleUnits(maxMeters,minUnitWidthPx);var possibleScales=this._getPossibleScales(possibleUnits,maxUnitsWidthPx);possibleScales.sort(function(scaleA,scaleB){return scaleB.score-scaleA.score});return possibleScales[0]},_getPossibleScales:function(possibleUnits,maxUnitsWidthPx){var scales=[];for(var i=0;i<this._possibleUnitsNumLen;i++){var numUnits=this._possibleUnitsNum[i];var numUnitsScore=this._possibleUnitsNumLen-i;for(var j=0;j<possibleUnits.length;j++){var unit=possibleUnits[j];var totalWidthPx=unit.unitPx*numUnits;if(totalWidthPx<maxUnitsWidthPx){var totalWidthPxScore=1-(maxUnitsWidthPx-totalWidthPx)/maxUnitsWidthPx;totalWidthPxScore*=3;var score=unit.unitScore+numUnitsScore+totalWidthPxScore;if(unit.unitDivision===.25&&numUnits===3||unit.unitDivision===.5&&numUnits===3||unit.unitDivision===.25&&numUnits===5){score-=2}scales.push({unit:unit,totalWidthPx:totalWidthPx,numUnits:numUnits,score:score})}}}return scales},_getPossibleUnits:function(maxMeters,minUnitWidthPx){var exp=(Math.floor(maxMeters)+"").length;var unitMetersPow;var units=[];for(var i=exp;i>0;i--){unitMetersPow=Math.pow(10,i);for(var j=0;j<this._possibleDivisionsLen;j++){var unitMeters=unitMetersPow*this._possibleDivisions[j];var unitPx=this._map.getSize().x*(unitMeters/maxMeters);if(unitPx<minUnitWidthPx){return units}units.push({unitMeters:unitMeters,unitPx:unitPx,unitDivision:this._possibleDivisions[j],unitScore:this._possibleDivisionsLen-j})}}},_render:function(unitWidthPx,unitsMultiple,unitMeters){var displayUnit=unitMeters<1e3?"m":"km";var unitLength=unitMeters;if(displayUnit==="km")unitLength/=1e3;for(var i=0;i<this._units.length;i++){var u=this._units[i];if(i<unitsMultiple){u.style.width=unitWidthPx+"px";u.className="unit";var lbl=this._unitsLbls[i];lbl.innerHTML=(i+1)*unitLength}else{u.style.width=0;u.className="unit hidden"}}}});L.Map.mergeOptions({graphicScaleControl:false});L.Map.addInitHook(function(){if(this.options.graphicScaleControl){this.graphicScaleControl=new L.Control.GraphicScale;this.addControl(this.graphicScaleControl)}});L.control.graphicScale=function(options){return new L.Control.GraphicScale(options)};